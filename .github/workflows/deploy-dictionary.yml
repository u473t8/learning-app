name: Deploy Dictionary
on:
  push:
    branches: [master]
    paths:
      - 'build.clj'
      - 'deps.edn'
      - 'tools/dictionary/**'
      - 'resources/dictionary/**'
      - '.github/workflows/deploy-dictionary.yml'

jobs:
  integration:
    uses: ./.github/workflows/integration.yml

  deployment:
    name: Build Dictionary Import
    runs-on: ubuntu-latest
    environment: deployment
    needs: integration
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Detect dictionary data changes
        id: dictionary-changes
        run: |
          set -euo pipefail
          before="${{ github.event.before }}"
          if [[ -z "$before" || "$before" == "0000000000000000000000000000000000000000" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git cat-file -e "$before^{commit}" 2>/dev/null; then
            if git diff --name-only "$before" "${{ github.sha }}" | grep -q "^resources/dictionary/"; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - uses: DeLaGuardo/setup-clojure@13.5.2
        with:
          cli: latest

      - uses: actions/cache/restore@v5.0.2
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          key: clojure-${{ hashFiles('deps.edn') }}

      - run: clojure -T:build dictionary-import

      - uses: actions/cache/save@v5.0.2
        if: always()
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          key: clojure-${{ hashFiles('deps.edn') }}

      - name: Ensure dictionary directories
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            sudo mkdir -p /opt/learning-app/dictionary /var/lib/learning-app/dictionary

      - name: Upload dictionary import jar
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 1
          source: 'target/dictionary-import.jar'
          target: '/opt/learning-app/dictionary/'
          overwrite: true

      - name: Upload dictionary import script
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 2
          source: 'tools/dictionary/import.sh'
          target: '/opt/learning-app/dictionary/'
          overwrite: true

      - name: Make import script executable
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            sudo chmod +x /opt/learning-app/dictionary/import.sh

      - name: Upload dictionary data
        if: steps.dictionary-changes.outputs.changed == 'true'
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 2
          source: 'resources/dictionary/*'
          target: '/var/lib/learning-app/dictionary/'
          overwrite: true
