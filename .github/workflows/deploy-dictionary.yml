name: Deploy Dictionary
on:
  workflow_call:

jobs:
  deployment:
    name: Build Dictionary Import
    runs-on: ubuntu-latest
    environment: deployment
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - uses: DeLaGuardo/setup-clojure@13.5.2
        with:
          cli: latest

      - id: cache-clojure
        uses: actions/cache/restore@v5.0.2
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          key: clojure-${{ hashFiles('deps.edn') }}

      - run: clojure -T:build dictionary-import

      - uses: actions/cache/save@v5.0.2
        if: ${{ always() && steps.cache-clojure.outputs.cache-hit != 'true' }}
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          key: clojure-${{ hashFiles('deps.edn') }}

      - name: Verify dictionary directories access
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            if [ ! -d /opt/learning-app/dictionary ]; then
              echo "ERROR: missing /opt/learning-app/dictionary; deploy infra first" >&2
              exit 1
            fi
            if [ ! -d /var/lib/learning-app/dictionary ]; then
              echo "ERROR: missing /var/lib/learning-app/dictionary; deploy infra first" >&2
              exit 1
            fi
            if [ ! -w /opt/learning-app/dictionary ]; then
              echo "ERROR: deploy user cannot write /opt/learning-app/dictionary" >&2
              exit 1
            fi
            if [ ! -w /var/lib/learning-app/dictionary ]; then
              echo "ERROR: deploy user cannot write /var/lib/learning-app/dictionary" >&2
              exit 1
            fi

      - name: Upload dictionary import jar
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 1
          source: 'target/dictionary-import.jar'
          target: '/opt/learning-app/dictionary/'
          overwrite: true

      - name: Upload dictionary import script
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 2
          source: 'tools/dictionary/import.sh'
          target: '/opt/learning-app/dictionary/'
          overwrite: true

      - name: Upload dictionary data
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 2
          source: 'resources/dictionary/*'
          target: '/var/lib/learning-app/dictionary/'
          overwrite: true

      - name: Run dictionary import service and smoke checks
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            if ! sudo -n systemctl --version >/dev/null 2>&1; then
              echo "ERROR: CI user must have passwordless sudo for deployment commands" >&2
              exit 1
            fi
            chmod 755 /opt/learning-app/dictionary/import.sh

            if ! sudo -n systemctl cat learning-app-dictionary-import.service >/dev/null 2>&1; then
              echo "ERROR: learning-app-dictionary-import.service is missing. Deploy infra first." >&2
              exit 1
            fi

            sudo -n systemctl daemon-reload
            sudo -n systemctl start learning-app-dictionary-import.service

            curl -sf http://127.0.0.1:5984/dictionary-db/dictionary-meta >/dev/null
            curl -sf --resolve sprecha.de:443:127.0.0.1 \
              https://sprecha.de/db/dictionary-db/dictionary-meta >/dev/null

            test -f /var/lib/learning-app/dictionary/import-metrics.json
