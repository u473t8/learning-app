name: Deploy Master
on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: Force infra, app, and dictionary deploy
        required: false
        type: boolean
        default: false
      deploy_infra:
        description: Deploy infrastructure only
        required: false
        type: boolean
        default: false
      deploy_app:
        description: Deploy application only
        required: false
        type: boolean
        default: false
      deploy_dictionary:
        description: Deploy dictionary only
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-master-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect deploy scope
    runs-on: ubuntu-latest
    outputs:
      infra_changed: ${{ steps.detect.outputs.infra_changed }}
      app_changed: ${{ steps.detect.outputs.app_changed }}
      dictionary_changed: ${{ steps.detect.outputs.dictionary_changed }}
      any_deploy: ${{ steps.detect.outputs.any_deploy }}
      selective_dispatch: ${{ steps.detect.outputs.selective_dispatch }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && "${FORCE_DEPLOY}" == "true" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            echo "app_changed=true" >> "$GITHUB_OUTPUT"
            echo "dictionary_changed=true" >> "$GITHUB_OUTPUT"
            echo "any_deploy=true" >> "$GITHUB_OUTPUT"
            echo "selective_dispatch=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            infra_manual="${DISPATCH_DEPLOY_INFRA}"
            app_manual="${DISPATCH_DEPLOY_APP}"
            dictionary_manual="${DISPATCH_DEPLOY_DICTIONARY}"

            if [[ "${infra_manual}" == "true" || "${app_manual}" == "true" || "${dictionary_manual}" == "true" ]]; then
              echo "infra_changed=${infra_manual}" >> "$GITHUB_OUTPUT"
              echo "app_changed=${app_manual}" >> "$GITHUB_OUTPUT"
              echo "dictionary_changed=${dictionary_manual}" >> "$GITHUB_OUTPUT"
              echo "any_deploy=true" >> "$GITHUB_OUTPUT"
              echo "selective_dispatch=true" >> "$GITHUB_OUTPUT"

              exit 0
            fi

            echo "ERROR: workflow_dispatch requires at least one target (deploy_infra/deploy_app/deploy_dictionary) or force_deploy=true" >&2
            exit 1
          fi

          before="${{ github.event.before }}"
          if [[ -z "${before}" || "${before}" == "0000000000000000000000000000000000000000" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            echo "app_changed=true" >> "$GITHUB_OUTPUT"
            echo "dictionary_changed=true" >> "$GITHUB_OUTPUT"
            echo "any_deploy=true" >> "$GITHUB_OUTPUT"
            echo "selective_dispatch=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git cat-file -e "${before}^{commit}" 2>/dev/null; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            echo "app_changed=true" >> "$GITHUB_OUTPUT"
            echo "dictionary_changed=true" >> "$GITHUB_OUTPUT"
            echo "any_deploy=true" >> "$GITHUB_OUTPUT"
            echo "selective_dispatch=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          python3 - <<'PY'
          import fnmatch
          import os
          import subprocess

          before = os.environ["RESOLVED_BEFORE"]
          sha = os.environ["GITHUB_SHA"]
          output_path = os.environ["GITHUB_OUTPUT"]

          changed = subprocess.check_output(["git", "diff", "--name-only", before, sha], text=True).splitlines()

          infra_patterns = [
              "infra/production/**",
              ".github/workflows/deploy-master.yml",
              ".github/workflows/deploy-infra.yml",
              ".github/workflows/deploy-app.yml",
              ".github/workflows/deploy-dictionary.yml",
          ]

          app_patterns = [
              "build.clj",
              "deps.edn",
              "shadow-cljs.edn",
              "src/**",
              "resources/**",
              "package.json",
              "package-lock.json",
          ]
          app_excludes = [
              "resources/dictionary/**",
          ]

          dictionary_patterns = [
              "build.clj",
              "deps.edn",
              "tools/dictionary/**",
              "resources/dictionary/**",
          ]

          def any_match(path, patterns):
              return any(fnmatch.fnmatch(path, pattern) for pattern in patterns)

          infra = any(any_match(path, infra_patterns) for path in changed)
          app = any(any_match(path, app_patterns) and not any_match(path, app_excludes) for path in changed)
          dictionary = any(any_match(path, dictionary_patterns) for path in changed)

          any_deploy = infra or app or dictionary

          print(f"before={before}")
          print(f"sha={sha}")
          print("changed files:")
          for path in changed:
              print(f"- {path}")
          print(
              f"resolved flags infra_changed={'true' if infra else 'false'} "
              f"app_changed={'true' if app else 'false'} "
              f"dictionary_changed={'true' if dictionary else 'false'} "
              f"any_deploy={'true' if any_deploy else 'false'}"
          )

          with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"infra_changed={'true' if infra else 'false'}\n")
              fh.write(f"app_changed={'true' if app else 'false'}\n")
              fh.write(f"dictionary_changed={'true' if dictionary else 'false'}\n")
              fh.write(f"any_deploy={'true' if any_deploy else 'false'}\n")
              fh.write("selective_dispatch=false\n")
          PY
        env:
          RESOLVED_BEFORE: ${{ github.event.before }}
          FORCE_DEPLOY: ${{ github.event.inputs.force_deploy || 'false' }}
          DISPATCH_DEPLOY_INFRA: ${{ github.event.inputs.deploy_infra || 'false' }}
          DISPATCH_DEPLOY_APP: ${{ github.event.inputs.deploy_app || 'false' }}
          DISPATCH_DEPLOY_DICTIONARY: ${{ github.event.inputs.deploy_dictionary || 'false' }}

      - name: Log deploy scope
        run: |
          echo "infra_changed=${{ steps.detect.outputs.infra_changed }}"
          echo "app_changed=${{ steps.detect.outputs.app_changed }}"
          echo "dictionary_changed=${{ steps.detect.outputs.dictionary_changed }}"
          echo "any_deploy=${{ steps.detect.outputs.any_deploy }}"
          echo "selective_dispatch=${{ steps.detect.outputs.selective_dispatch }}"

  integration:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' }}
    needs: detect-changes
    uses: ./.github/workflows/integration.yml

  deploy-infra:
    if: ${{ needs.detect-changes.outputs.infra_changed == 'true' }}
    needs: [detect-changes, integration]
    uses: ./.github/workflows/deploy-infra.yml
    secrets: inherit

  infra-ready:
    name: Wait for infra readiness
    if: ${{ always() && needs.detect-changes.outputs.any_deploy == 'true' }}
    needs: [detect-changes, deploy-infra]
    runs-on: ubuntu-latest
    environment: deployment
    steps:
      - name: Skip readiness checks when infra unchanged
        if: ${{ needs.detect-changes.outputs.infra_changed != 'true' }}
        run: echo "Infra unchanged; readiness gate passed"

      - name: Ensure infra deployment succeeded
        if: ${{ needs.detect-changes.outputs.infra_changed == 'true' && needs.deploy-infra.result != 'success' }}
        run: |
          echo "Infra deployment failed; app and dictionary deploy are blocked" >&2
          exit 1

      - name: Verify services after infra deployment
        if: ${{ needs.detect-changes.outputs.infra_changed == 'true' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            if ! sudo -n systemctl --version >/dev/null 2>&1; then
              echo "ERROR: CI user must have passwordless sudo for deployment commands" >&2
              exit 1
            fi
            for i in $(seq 1 30); do
              if sudo -n systemctl is-active --quiet couchdb.service \
                 && sudo -n systemctl cat learning-app-dictionary-import.service >/dev/null 2>&1 \
                 && sudo -n nginx -t >/dev/null 2>&1 \
                 && curl -sf http://127.0.0.1:5984/ >/dev/null; then
                exit 0
              fi
              sleep 2
            done

            echo "ERROR: Infra readiness check failed" >&2
            sudo -n systemctl status couchdb.service --no-pager || true
            sudo -n systemctl cat learning-app-dictionary-import.service || true
            sudo -n nginx -t || true
            exit 1

  deploy-app:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' && (needs.detect-changes.outputs.app_changed == 'true' || (needs.detect-changes.outputs.infra_changed == 'true' && needs.detect-changes.outputs.selective_dispatch != 'true')) }}
    needs: [detect-changes, integration, infra-ready]
    uses: ./.github/workflows/deploy-app.yml
    secrets: inherit

  deploy-dictionary:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' && (needs.detect-changes.outputs.dictionary_changed == 'true' || (needs.detect-changes.outputs.infra_changed == 'true' && needs.detect-changes.outputs.selective_dispatch != 'true')) }}
    needs: [detect-changes, integration, infra-ready]
    uses: ./.github/workflows/deploy-dictionary.yml
    secrets: inherit
