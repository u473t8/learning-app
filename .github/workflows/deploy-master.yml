name: Deploy Master
on:
  push:
    branches: [master]

concurrency:
  group: deploy-master-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect deploy scope
    runs-on: ubuntu-latest
    outputs:
      infra_changed: ${{ steps.detect.outputs.infra_changed }}
      app_changed: ${{ steps.detect.outputs.app_changed }}
      dictionary_changed: ${{ steps.detect.outputs.dictionary_changed }}
      any_deploy: ${{ steps.detect.outputs.any_deploy }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - id: detect
        shell: bash
        run: |
          set -euo pipefail

          before="${{ github.event.before }}"
          if [[ -z "${before}" || "${before}" == "0000000000000000000000000000000000000000" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            echo "app_changed=true" >> "$GITHUB_OUTPUT"
            echo "dictionary_changed=true" >> "$GITHUB_OUTPUT"
            echo "any_deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git cat-file -e "${before}^{commit}" 2>/dev/null; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            echo "app_changed=true" >> "$GITHUB_OUTPUT"
            echo "dictionary_changed=true" >> "$GITHUB_OUTPUT"
            echo "any_deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          python3 - <<'PY'
          import fnmatch
          import os
          import subprocess

          before = os.environ["GITHUB_EVENT_BEFORE"]
          sha = os.environ["GITHUB_SHA"]
          output_path = os.environ["GITHUB_OUTPUT"]

          changed = subprocess.check_output(["git", "diff", "--name-only", before, sha], text=True).splitlines()

          infra_patterns = [
              "infra/production/**",
          ]

          app_patterns = [
              "build.clj",
              "deps.edn",
              "shadow-cljs.edn",
              "src/**",
              "resources/**",
              "package.json",
              "package-lock.json",
          ]
          app_excludes = [
              "resources/dictionary/**",
          ]

          dictionary_patterns = [
              "build.clj",
              "deps.edn",
              "tools/dictionary/**",
              "resources/dictionary/**",
          ]

          def any_match(path, patterns):
              return any(fnmatch.fnmatch(path, pattern) for pattern in patterns)

          infra = any(any_match(path, infra_patterns) for path in changed)
          app = any(any_match(path, app_patterns) and not any_match(path, app_excludes) for path in changed)
          dictionary = any(any_match(path, dictionary_patterns) for path in changed)

          any_deploy = infra or app or dictionary

          with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"infra_changed={'true' if infra else 'false'}\n")
              fh.write(f"app_changed={'true' if app else 'false'}\n")
              fh.write(f"dictionary_changed={'true' if dictionary else 'false'}\n")
              fh.write(f"any_deploy={'true' if any_deploy else 'false'}\n")
          PY
        env:
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}

  integration:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' }}
    needs: detect-changes
    uses: ./.github/workflows/integration.yml

  deploy-infra:
    if: ${{ needs.detect-changes.outputs.infra_changed == 'true' }}
    needs: [detect-changes, integration]
    uses: ./.github/workflows/deploy-infra.yml
    secrets: inherit

  infra-ready:
    name: Wait for infra readiness
    if: ${{ always() && needs.detect-changes.outputs.any_deploy == 'true' }}
    needs: [detect-changes, deploy-infra]
    runs-on: ubuntu-latest
    steps:
      - name: Skip readiness checks when infra unchanged
        if: ${{ needs.detect-changes.outputs.infra_changed != 'true' }}
        run: echo "Infra unchanged; readiness gate passed"

      - name: Ensure infra deployment succeeded
        if: ${{ needs.detect-changes.outputs.infra_changed == 'true' && needs.deploy-infra.result != 'success' }}
        run: |
          echo "Infra deployment failed; app and dictionary deploy are blocked" >&2
          exit 1

      - name: Verify services after infra deployment
        if: ${{ needs.detect-changes.outputs.infra_changed == 'true' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            for i in $(seq 1 30); do
              if sudo systemctl is-active --quiet couchdb.service \
                 && sudo systemctl cat learning-app-dictionary-import.service >/dev/null 2>&1 \
                 && sudo nginx -t >/dev/null 2>&1 \
                 && curl -sf http://127.0.0.1:5984/ >/dev/null; then
                exit 0
              fi
              sleep 2
            done

            echo "ERROR: Infra readiness check failed" >&2
            sudo systemctl status couchdb.service --no-pager || true
            sudo systemctl cat learning-app-dictionary-import.service || true
            sudo nginx -t || true
            exit 1

  deploy-app:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' && (needs.detect-changes.outputs.app_changed == 'true' || needs.detect-changes.outputs.infra_changed == 'true') }}
    needs: [detect-changes, integration, infra-ready]
    uses: ./.github/workflows/deploy-app.yml
    secrets: inherit

  deploy-dictionary:
    if: ${{ needs.detect-changes.outputs.any_deploy == 'true' && (needs.detect-changes.outputs.dictionary_changed == 'true' || needs.detect-changes.outputs.infra_changed == 'true') }}
    needs: [detect-changes, integration, infra-ready]
    uses: ./.github/workflows/deploy-dictionary.yml
    secrets: inherit
