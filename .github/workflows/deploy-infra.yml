name: Deploy Infrastructure
on:
  workflow_dispatch:

jobs:
  deployment:
    name: Build Infra Package
    runs-on: ubuntu-latest
    environment: deployment
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Build infra deb
        run: mkdir -p target && dpkg-deb --root-owner-group --build infra/production target/learning-app-infra.deb

      - name: Upload infra deb
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          strip_components: 1
          source: 'target/learning-app-infra.deb'
          target: '/tmp/'
          overwrite: true

      - name: Install infra deb and restart app
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -euo pipefail
            if ! sudo -n systemctl --version >/dev/null 2>&1; then
              echo "ERROR: CI user must have passwordless sudo for deployment commands" >&2
              exit 1
            fi
            if ! sudo -n dpkg -i /tmp/learning-app-infra.deb; then
              sudo -n apt-get -f install -y
              sudo -n dpkg -i /tmp/learning-app-infra.deb
            fi
            sudo -n systemctl daemon-reload
            sudo -n systemctl restart learning-app-run.service
