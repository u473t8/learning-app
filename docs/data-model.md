# Data Model

This document describes the document shapes stored in the local PouchDB
("local-db") and synced to CouchDB. PouchDB/CouchDB are schemaless, so this
file is the source of truth for expected fields.

## Common fields

- _id: string (generated by PouchDB)
- _rev: string (managed by PouchDB/CouchDB)
- type: string (document type discriminator)

## Document types

### Vocabulary word

type: "vocab"

Fields:
- value: string (German word)
- lang: string (language code, e.g. "de")
- translation: array of translation objects

Translation object:
- lang: string (e.g. "ru")
- value: string

Example:
```json
{
  "type": "vocab",
  "value": "der Hund",
  "lang": "de",
  "translation": [{"lang": "ru", "value": "пёс"}]
}
```

### Review

type: "review"

Fields:
- word-id: string (references vocab document _id)
- retained: boolean
- timestamp: string (ISO-8601)
- translation: array of translation objects

Example:
```json
{
  "type": "review",
  "word-id": "<vocab-id>",
  "retained": true,
  "timestamp": "2024-08-20T10:11:12.000Z",
  "translation": [{"lang": "ru", "value": "пёс"}]
}
```

### Example (planned)

type: "example"

Fields:
- word-id: string (references vocab document _id)
- word: string (German word value used to request the example)
- value: string (German sentence)
- translation: string (Russian translation)
- structure: array of structure objects
- created-at: string (ISO-8601, client time)

Structure object:
- usedForm: string
- dictionaryForm: string
- translation: string

Example:
```json
{
  "type": "example",
  "word-id": "<vocab-id>",
  "word": "der Hund",
  "value": "Der Hund schlaeft unter dem Tisch.",
  "translation": "Пёс спит под столом.",
  "structure": [
    {"usedForm": "Hund", "dictionaryForm": "der Hund", "translation": "пёс"},
    {"usedForm": "schlaeft", "dictionaryForm": "schlafen", "translation": "спать"}
  ],
  "created-at": "2024-08-20T10:12:30.000Z"
}
```

### Lesson (local)

type: "lesson"

A lesson uses a trial-based system where words and examples are separate
challenges. Trials are selected randomly from the unpassed pool until all
are completed.

Fields:
- _id: string (fixed: "lesson")
- started-at: string (ISO-8601, client time)
- words: array of lesson word objects (reference data)
- trials: array of trial objects (all trials for this lesson)
- remaining-trials: array of trial objects (unpassed trials)
- current-trial: trial object or null
- last-result: result object or null

Lesson word object:
- id: string (references vocab document _id)
- value: string (German word)
- translation: string (Russian translation)
- retention-level: number
- example: object (optional)

Example object (embedded in word):
- id: string (example document _id)
- value: string (German sentence)
- translation: string (Russian translation)
- structure: array (see Example document)

Trial object:
- word-id: string (references word.id in the words array)
- type: string ("word" or "example")

Result object:
- correct?: boolean
- correct-answer: string (the expected German text)

Example:
```json
{
  "_id": "lesson",
  "type": "lesson",
  "started-at": "2024-08-20T10:12:30.000Z",
  "words": [
    {
      "id": "<vocab-id>",
      "value": "der Hund",
      "translation": "пёс",
      "retention-level": 42,
      "example": {
        "id": "<example-id>",
        "value": "Der Hund schlaeft unter dem Tisch.",
        "translation": "Пёс спит под столом.",
        "structure": []
      }
    }
  ],
  "trials": [
    {"word-id": "<vocab-id>", "type": "word"},
    {"word-id": "<vocab-id>", "type": "example"}
  ],
  "remaining-trials": [
    {"word-id": "<vocab-id>", "type": "example"}
  ],
  "current-trial": {"word-id": "<vocab-id>", "type": "word"},
  "last-result": {"correct?": true, "correct-answer": "der Hund"}
}
```

Trial generation:
- For each word, always add a "word" trial
- If the word has an example, also add an "example" trial
- Total trials = words + examples (e.g., 3 words + 2 examples = 5 trials)

Lesson flow:
1. Start: generate trials, copy to remaining-trials, pick random current-trial
2. Check answer: if correct, remove from remaining-trials; set last-result
3. Advance: pick next random from remaining-trials, clear last-result
4. Finish: when remaining-trials is empty

Notes:
- Example documents are created by the client after fetching
  /examples?word=<word> from the backend.
- On successful example trial, the old example is deleted and a new one
  is fetched from the backend.
- If multiple examples per word are needed in the future, store multiple
  "example" docs per word-id.
